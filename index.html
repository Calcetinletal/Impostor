<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Impostor ‚Äî C√≥digo de ronda</title>
  <style>
    :root{
      --bg:#0b0f17; --card:#121a2a; --card2:#0b1220; --b:#223050;
      --txt:#e8eefc; --muted:#a9b7d6; --accent:#2e6bff; --accent2:#1b2740; --danger:#d84b4b; --ok:#2ecc71;
    }
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;background:var(--bg);color:var(--txt)}
    .wrap{max-width:820px;margin:0 auto;padding:18px}
    .card{background:var(--card);border:1px solid var(--b);border-radius:16px;padding:18px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    h1{font-size:20px;margin:0 0 10px}
    .muted{color:var(--muted);font-size:14px;line-height:1.35}
    .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px;align-items:center}
    input, select{
      flex:1;min-width:180px;background:var(--card2);border:1px solid var(--b);color:var(--txt);
      border-radius:12px;padding:12px;font-size:16px
    }
    button{background:var(--accent);border:0;color:white;border-radius:12px;padding:12px 14px;font-size:16px;cursor:pointer}
    button.secondary{background:var(--accent2)}
    button.danger{background:var(--danger)}
    button.ok{background:var(--ok)}
    .hr{height:1px;background:var(--b);margin:14px 0}
    .pill{display:inline-block;padding:6px 10px;border-radius:999px;background:var(--accent2);border:1px solid var(--b);font-size:13px;color:#cfe0ff}
    .big{font-size:22px;font-weight:700;margin:10px 0}
    .box{background:var(--card2);border:1px solid var(--b);border-radius:14px;padding:12px}
    .codeBox{
      font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;
      font-size:22px; letter-spacing:1px;
      background:#070c15;border:1px solid var(--b); border-radius:14px;
      padding:14px; margin-top:10px; word-break:break-all;
    }
    .reveal{
      font-size:18px;line-height:1.4;white-space:pre-wrap;
      background:#070c15;border:1px solid var(--b);border-radius:14px;
      padding:14px;margin-top:12px
    }
    .hint{font-size:12px;color:var(--muted);margin-top:6px}
    .warn{color:#ffd6a6}
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>Impostor ‚Äî C√≥digo de ronda (simple)</h1>
    <div class="muted">
      <b>Enlace solo una vez</b>. Luego cada ronda el anfitri√≥n comparte un <b>c√≥digo</b>.
      Si todos ten√©is el mismo <b>Sala + Ronda + Clave</b> y el mismo <b>Tema</b>, est√°is sincronizados.
    </div>

    <!-- LANDING -->
    <div id="screenLanding">
      <div class="row">
        <button class="ok" id="goHost">Soy anfitri√≥n</button>
        <button class="secondary" id="goPlayer">Soy jugador</button>
      </div>
      <div class="hint warn">
        Sin servidor no hay forma de evitar que alguien cambie su slot para curiosear.
      </div>
    </div>

    <!-- HOST -->
    <div id="screenHost" style="display:none;">
      <div class="big">Anfitri√≥n</div>

      <div class="box">
        <div class="muted">Ajustes de la partida (ponlos una vez y no los cambies):</div>

        <div class="row">
          <input id="hRoom" placeholder="Sala (ej: FAMILIA)" />
          <input id="hPlayers" type="number" min="3" value="6" />
          <input id="hImpostors" type="number" min="1" value="1" />
        </div>

        <div class="row">
          <select id="hTopicMode">
            <option value="random">Tema aleatorio</option>
            <option value="choose">Tema fijo (elegir)</option>
          </select>
          <select id="hTopicSelect" style="display:none;"></select>
        </div>

        <div class="row">
          <button class="ok" id="hStart">Crear partida</button>
          <button class="secondary" id="hNext" disabled>Nueva ronda</button>
          <button class="danger" id="hReset">Reset</button>
        </div>

        <div class="hint">
          El anfitri√≥n <b>NO ver√° la palabra</b>. Solo ver√° el <b>tema</b> para guiar.
        </div>
      </div>

      <div class="hr"></div>

      <div class="box">
        <div class="muted">C√ìDIGO DE RONDA (comp√°rtelo en el grupo):</div>
        <div class="codeBox" id="hCode">‚Äî</div>

        <div class="row">
          <button class="secondary" id="hCopy" disabled>Copiar c√≥digo</button>
        </div>

        <div class="hr"></div>

        <div class="row" style="justify-content:space-between">
          <span class="pill" id="hSync">Sala: ‚Äî ¬∑ Ronda: ‚Äî ¬∑ Clave: ‚Äî</span>
          <span class="pill" id="hTheme">Tema: ‚Äî</span>
        </div>

        <div class="hint">
          Para sincronizar: todos los jugadores pegan el <b>c√≥digo</b>, eligen su <b>slot</b> y le dan a ‚ÄúVer mi carta‚Äù.
        </div>
      </div>

      <div class="row">
        <button class="secondary" id="backFromHost">Volver</button>
      </div>
    </div>

    <!-- PLAYER -->
    <div id="screenPlayer" style="display:none;">
      <div class="big">Jugador</div>

      <div class="box">
        <div class="muted">Pega el c√≥digo que manda el anfitri√≥n:</div>
        <div class="row">
          <input id="pCode" placeholder="Ej: FAMILIA-3-K7Q2-6-1-R" />
        </div>

        <div class="row">
          <input id="pName" placeholder="Tu nombre (opcional)" />
          <input id="pSlot" type="number" min="1" value="1" />
        </div>

        <div class="row">
          <button class="ok" id="pShow">Ver mi carta</button>
          <button class="secondary" id="pHide" style="display:none;">Ocultar</button>
        </div>

        <div class="hint">
          Elegid slots fijos 1..N (uno por persona). Ej: Aita=1, Ama=2, etc.
        </div>
      </div>

      <div class="hr"></div>

      <div class="box">
        <div class="row" style="justify-content:space-between">
          <span class="pill" id="pSync">Sala: ‚Äî ¬∑ Ronda: ‚Äî ¬∑ Clave: ‚Äî</span>
          <span class="pill" id="pTheme">Tema: ‚Äî</span>
        </div>

        <div class="reveal" id="pCard" style="display:none;">‚Äî</div>
      </div>

      <div class="row">
        <button class="secondary" id="backFromPlayer">Volver</button>
      </div>
    </div>

    <div class="hr"></div>
    <div class="muted"><b>Listas:</b> puedes editar DATA en el c√≥digo si quieres.</div>
  </div>
</div>

<script>
/*** =========================
 *  LISTAS (DATA)
 *  ========================= */
const DATA = {
  "Pa√≠ses": ["Espa√±a","Portugal","Francia","Italia","Alemania","Reino Unido","Irlanda","Grecia","Turqu√≠a","Marruecos","Egipto","Israel","India","China","Jap√≥n","Corea del Sur","Australia","Estados Unidos","Canad√°","M√©xico"],
  "Animales": ["Perro","Gato","Caballo","Vaca","Oveja","Cerdo","Conejo","Elefante","Tigre","Le√≥n","Jirafa","Cebra","Oso panda","Koala","Lobo","Delf√≠n","Tibur√≥n","Ping√ºino","√Åguila","Serpiente"],
  "Famosos (muy conocidos)": ["Lionel Messi","Cristiano Ronaldo","Arnold Schwarzenegger","Will Smith","Tom Cruise","Leonardo DiCaprio","Brad Pitt","Johnny Depp","Dwayne Johnson","Keanu Reeves","Justin Bieber","Taylor Swift","Shakira","Beyonc√©","Rihanna","Adele","Ed Sheeran","Bad Bunny","Drake","Eminem","Rafa Nadal","Carlos Alcaraz","Michael Jordan","LeBron James","Kim Kardashian","Elon Musk","Bill Gates","Mark Zuckerberg","Jeff Bezos","Oprah Winfrey"],
  "Pol√≠ticos y l√≠deres (muy conocidos)": ["Donald Trump","Joe Biden","Barack Obama","Vladimir Putin","Xi Jinping","Volod√≠mir Zelenski","Nicol√°s Maduro","Javier Milei","Pedro S√°nchez","Mariano Rajoy","Santiago Abascal","Arnaldo Otegi","Felipe VI","Juan Carlos I","Emmanuel Macron","Giorgia Meloni","Ursula von der Leyen","Justin Trudeau","Angela Merkel"],
  "Figuras hist√≥ricas (muy conocidas)": ["Albert Einstein","Napole√≥n Bonaparte","Wolfgang Amadeus Mozart","Miguel de Cervantes","Mahatma Gandhi","Isaac Newton","Leonardo da Vinci","Julio C√©sar","Alejandro Magno","Cleopatra","Crist√≥bal Col√≥n","Sim√≥n Bol√≠var","Martin Luther King Jr.","Nelson Mandela","Winston Churchill","Adolf Hitler","Joseph Stalin","Beethoven","William Shakespeare","Marie Curie"],
  "Profesiones": ["M√©dico","Enfermero","Profesor","Ingeniero","Arquitecto","Abogado","Juez","Polic√≠a","Bombero","Piloto","Cocinero","Camarero","Mec√°nico","Electricista","Fontanero","Carpintero","Periodista","Fot√≥grafo","Veterinario","Programador"],
  "Comidas y Bebidas": ["Paella","Tortilla de patatas","Gazpacho","Croquetas","Jam√≥n ib√©rico","Pizza","Hamburguesa","Sushi","Ramen","Tacos","Burrito","Kebab","Pasta carbonara","Curry","Ceviche","Caf√©","T√©","Zumo de naranja","Cerveza","Vino"],
  "Lugares comunes": ["Playa","Monta√±a","Parque","Bosque","R√≠o","Lago","Centro comercial","Supermercado","Aeropuerto","Estaci√≥n de tren","Hospital","Colegio","Universidad","Biblioteca","Museo","Cine","Restaurante","Bar","Gimnasio","Hotel"],
  "Edificios y monumentos (muy conocidos)": ["Torre Eiffel","Coliseo de Roma","Sagrada Familia","Alhambra","Big Ben","Taj Mahal","Estatua de la Libertad","Gran Muralla China","Pir√°mides de Giza","Machu Picchu","√ìpera de S√≠dney","Burj Khalifa","Kremlin","Bas√≠lica de San Pedro","Notre Dame","Palacio de Versalles","Torre de Pisa","Puerta de Brandeburgo","Stonehenge","Mezquita-Catedral de C√≥rdoba"],
  "Objetos comunes": ["M√≥vil","Cargador","Auriculares","Port√°til","Teclado","Rat√≥n","Televisor","Mando a distancia","Altavoz","Reloj","Llaves","Cartera","Mochila","Botella de agua","Vaso","Taza","Plato","Cuchillo","Tenedor","Cuchara"],
  "Conocidos (privado)": ["Loren","Aita","Ama","Nerea","Ainhoa","Javi","Juan","Isabel","Miguel","Nelson","Ernesto","Ane","Judit","Amona","Amo√±i","Mamen","Fugas","Txiki","La atia"]
};
const TOPICS = Object.keys(DATA);

/*** =========================
 *  RNG determinista (seed)
 *  ========================= */
function cyrb128(str) {
  let h1=1779033703, h2=3144134277, h3=1013904242, h4=2773480762;
  for (let i=0,k;i<str.length;i++) {
    k=str.charCodeAt(i);
    h1=h2^Math.imul(h1^k,597399067);
    h2=h3^Math.imul(h2^k,2869860233);
    h3=h4^Math.imul(h3^k,951274213);
    h4=h1^Math.imul(h4^k,2716044179);
  }
  h1=Math.imul(h3^(h1>>>18),597399067);
  h2=Math.imul(h4^(h2>>>22),2869860233);
  h3=Math.imul(h1^(h3>>>17),951274213);
  h4=Math.imul(h2^(h4>>>19),2716044179);
  return [(h1^h2^h3^h4)>>>0,(h2^h1)>>>0,(h3^h1)>>>0,(h4^h1)>>>0];
}
function sfc32(a,b,c,d){ return function(){ a>>>=0;b>>>=0;c>>>=0;d>>>=0;
  let t=(a+b)|0; a=b^(b>>>9); b=(c+(c<<3))|0; c=(c<<21)|(c>>>11); d=(d+1)|0;
  t=(t+d)|0; c=(c+t)|0; return (t>>>0)/4294967296; }; }
function rngFrom(seedStr){ const s=cyrb128(seedStr); return sfc32(s[0],s[1],s[2],s[3]); }
function randInt(rng,n){ return Math.floor(rng()*n); }
function pick(rng,arr){ return arr[randInt(rng,arr.length)]; }

function clampImpostors(n,k){ k=Math.max(1,Math.floor(k)); return Math.min(k,n-1); }
function sampleImpostors(rng,n,k){
  const set=new Set();
  while(set.size<k){ set.add(randInt(rng,n)+1); }
  return set;
}

/*** =========================
 *  C√≥digo de ronda
 *  =========================
 * Formato: ROOM-ROUND-KEY-N-K-T
 *  - ROOM: texto sin guiones (se normaliza)
 *  - ROUND: n√∫mero
 *  - KEY: 4 chars (aleatorio por ronda)
 *  - N: jugadores
 *  - K: impostores
 *  - T: R (tema random) o C (tema fijo) + √≠ndice (si fijo) -> ej: C3
 */
function normalizeRoom(s){
  return (s||"").trim().toUpperCase().replace(/\s+/g,"").replace(/[^A-Z0-9]/g,"");
}
function makeKey4(){
  const chars="ABCDEFGHJKMNPQRSTUVWXYZ23456789"; // sin I,O,1,0
  let out="";
  for(let i=0;i<4;i++) out+=chars[Math.floor(Math.random()*chars.length)];
  return out;
}
function packCode({room,round,key,n,k,topicMode,topicIndex}){
  const ROOM=normalizeRoom(room);
  const T = (topicMode==="choose") ? `C${topicIndex}` : "R";
  return `${ROOM}-${round}-${key}-${n}-${k}-${T}`;
}
function parseCode(code){
  const raw=(code||"").trim().toUpperCase();
  const parts=raw.split("-").filter(Boolean);
  if(parts.length<6) return null;
  const [ROOM, ROUND, KEY, N, K, T] = parts;
  const round = parseInt(ROUND,10);
  const n = parseInt(N,10);
  const k = parseInt(K,10);
  if(!ROOM || !KEY || !Number.isFinite(round) || !Number.isFinite(n) || !Number.isFinite(k)) return null;
  if(KEY.length!==4) return null;
  let topicMode="random", topicIndex=0;
  if(T.startsWith("C")){
    topicMode="choose";
    topicIndex=parseInt(T.slice(1),10);
    if(!Number.isFinite(topicIndex) || topicIndex<0 || topicIndex>=TOPICS.length) return null;
  }else if(T==="R"){
    topicMode="random";
  }else{
    return null;
  }
  return { room:ROOM, round, key:KEY, n, k, topicMode, topicIndex };
}

/*** =========================
 *  Motor de ronda (desde c√≥digo)
 *  ========================= */
function computeFromCode(parsed){
  const {room,round,key,n,k,topicMode,topicIndex} = parsed;
  const K = clampImpostors(n,k);
  const seedBase = `ROOM=${room}|ROUND=${round}|KEY=${key}|N=${n}|K=${K}|T=${topicMode}|TI=${topicIndex}`;
  const rng = rngFrom(seedBase);

  const topic = (topicMode==="choose") ? TOPICS[topicIndex] : TOPICS[randInt(rng, TOPICS.length)];
  const word = pick(rng, DATA[topic]);
  const impostors = sampleImpostors(rng, n, K);
  return { topic, word, impostors, n, k:K, room, round, key };
}

/*** =========================
 *  UI wiring
 *  ========================= */
const S = {
  landing: document.getElementById("screenLanding"),
  host: document.getElementById("screenHost"),
  player: document.getElementById("screenPlayer")
};
function showScreen(which){
  S.landing.style.display = (which==="landing")?"block":"none";
  S.host.style.display = (which==="host")?"block":"none";
  S.player.style.display = (which==="player")?"block":"none";
}

document.getElementById("goHost").onclick = ()=>showScreen("host");
document.getElementById("goPlayer").onclick = ()=>showScreen("player");
document.getElementById("backFromHost").onclick = ()=>showScreen("landing");
document.getElementById("backFromPlayer").onclick = ()=>showScreen("landing");

/*** Host setup */
const hTopicSelect = document.getElementById("hTopicSelect");
TOPICS.forEach((t,i)=>{
  const opt=document.createElement("option");
  opt.value=String(i);
  opt.textContent=t;
  hTopicSelect.appendChild(opt);
});
document.getElementById("hTopicMode").addEventListener("change",(e)=>{
  hTopicSelect.style.display = (e.target.value==="choose") ? "block" : "none";
});

let currentHost = { started:false, room:"", n:6, k:1, topicMode:"random", topicIndex:0, round:1, key:"" };

function hostRender(){
  if(!currentHost.started){
    document.getElementById("hCode").textContent = "‚Äî";
    document.getElementById("hCopy").disabled = true;
    document.getElementById("hNext").disabled = true;
    document.getElementById("hSync").textContent = "Sala: ‚Äî ¬∑ Ronda: ‚Äî ¬∑ Clave: ‚Äî";
    document.getElementById("hTheme").textContent = "Tema: ‚Äî";
    return;
  }
  const code = packCode(currentHost);
  document.getElementById("hCode").textContent = code;
  document.getElementById("hCopy").disabled = false;
  document.getElementById("hNext").disabled = false;

  const out = computeFromCode(parseCode(code));
  document.getElementById("hSync").textContent = `Sala: ${out.room} ¬∑ Ronda: ${out.round} ¬∑ Clave: ${out.key}`;
  document.getElementById("hTheme").textContent = `Tema: ${out.topic}`;
}

document.getElementById("hStart").onclick = ()=>{
  const room = normalizeRoom(document.getElementById("hRoom").value);
  let n = Math.max(3, parseInt(document.getElementById("hPlayers").value||"6",10));
  let k = parseInt(document.getElementById("hImpostors").value||"1",10);
  k = clampImpostors(n,k);

  const topicMode = document.getElementById("hTopicMode").value;
  const topicIndex = parseInt(document.getElementById("hTopicSelect").value||"0",10);

  if(!room){
    alert("Pon una sala (ej: FAMILIA).");
    return;
  }

  currentHost = {
    started:true,
    room, n, k,
    topicMode,
    topicIndex: Number.isFinite(topicIndex)?topicIndex:0,
    round: 1,
    key: makeKey4()
  };
  hostRender();
};

document.getElementById("hNext").onclick = ()=>{
  if(!currentHost.started) return;
  currentHost.round += 1;
  currentHost.key = makeKey4(); // clave nueva por ronda (evita que se ‚Äúadivine‚Äù)
  hostRender();
};

document.getElementById("hReset").onclick = ()=>{
  currentHost = { started:false, room:"", n:6, k:1, topicMode:"random", topicIndex:0, round:1, key:"" };
  hostRender();
};

document.getElementById("hCopy").onclick = async ()=>{
  const code = document.getElementById("hCode").textContent;
  try{
    await navigator.clipboard.writeText(code);
    alert("C√≥digo copiado. P√©galo en el grupo.");
  }catch(e){
    alert("No pude copiar. Selecciona el c√≥digo y c√≥pialo manualmente.");
  }
};

/*** Player */
document.getElementById("pShow").onclick = ()=>{
  const code = document.getElementById("pCode").value.trim();
  const parsed = parseCode(code);
  if(!parsed){
    alert("C√≥digo inv√°lido. Debe ser tipo: FAMILIA-3-K7Q2-6-2-R (o ...-C5)");
    return;
  }
  const slot = Math.max(1, parseInt(document.getElementById("pSlot").value||"1",10));
  if(slot > parsed.n){
    alert(`Tu slot debe estar entre 1 y ${parsed.n}.`);
    return;
  }

  const out = computeFromCode(parsed);
  const isImp = out.impostors.has(slot);
  const name = (document.getElementById("pName").value||"").trim();

  document.getElementById("pSync").textContent = `Sala: ${out.room} ¬∑ Ronda: ${out.round} ¬∑ Clave: ${out.key}`;
  document.getElementById("pTheme").textContent = `Tema: ${out.topic}`;

  const card = document.getElementById("pCard");
  card.style.display = "block";
  card.textContent = isImp
    ? `Eres el IMPOSTOR üòà\nTema: ${out.topic}\nPalabra: (no la sabes)\n\nSlot: ${slot}${name?` (${name})`:""}`
    : `No eres impostor ‚úÖ\nTema: ${out.topic}\nPalabra: ${out.word}\n\nSlot: ${slot}${name?` (${name})`:""}`;

  document.getElementById("pHide").style.display = "inline-block";
};

document.getElementById("pHide").onclick = ()=>{
  document.getElementById("pCard").style.display = "none";
  document.getElementById("pHide").style.display = "none";
};

// start
showScreen("landing");
hostRender();
</script>
</body>
</html>
